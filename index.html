<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Availability Heatmap</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    #map { width: 100%; height: 500px; }
    #panel { margin: 10px 0; }
   .count-label {
  background: transparent;
  border: none;
}

.count-label div {
  display: inline-block;
  min-width: 22px;
  height: 22px;
  line-height: 22px;
  text-align: center;

  background: rgba(255,255,255,0.9);
  border: 1px solid #111;
  border-radius: 11px;

  font-size: 12px;
  font-weight: 700;
  color: #111;

  box-shadow: 0 1px 4px rgba(0,0,0,0.25);
  pointer-events: auto;
}

  </style>
</head>
<body>

<div id="panel">
  <label>
    <input type="checkbox" id="showAll"> Show all (not only available)
  </label>
</div>

<div id="map"></div>

<script>
const dataUrl = 'https://mgfrv.github.io/mfg-heatmap/map.json';

const regionCoords = {
  "California":[36.7783,-119.4179],
  "Texas":[31.9686,-99.9018],
  "Florida":[27.6648,-81.5158],
  "New York":[43,-75],
  "Illinois":[40,-89],
  "Pennsylvania":[41.2033,-77.1945],
  "Ohio":[40.4173,-82.9071],
  "Georgia":[32.1656,-82.9001]
};

const map = L.map('map').setView([39.8283,-98.5795],4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18,
  attribution:'Â© OpenStreetMap'
}).addTo(map);

let heatLayer;
let markers = [];

function loadData() {
  fetch(dataUrl + '?t=' + Date.now())
    .then(r => r.json())
    .then(rows => render(rows));
}

function render(rows) {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  const showAll = document.getElementById('showAll').checked;
  const counts = {};

  rows.forEach(r => {
    if (!showAll && !r.available) return;
    counts[r.region] = (counts[r.region] || 0) + 1;
  });

  const points = [];
  Object.entries(counts).forEach(([region,count]) => {
    if (!regionCoords[region]) return;
    const [lat,lon] = regionCoords[region];
    points.push([lat,lon,count]);

const icon = L.divIcon({
  className: 'count-label',
  html: `<div>${count}</div>`,
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

});

const marker = L.marker([lat, lon], { icon })
  .bindTooltip(region + ': ' + count + ' companies')
  .on('click', () => alert(region + ': ' + count + ' companies'));

markers.push(marker.addTo(map));

  });

  if (heatLayer) map.removeLayer(heatLayer);
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  heatLayer = L.heatLayer(points,{
    radius:40,
    blur:25,
    maxZoom:6
  }).addTo(map);
}

document.getElementById('showAll').addEventListener('change', loadData);

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>


